name: MQTT Publish on Commit

on:
  push:
    branches:
      - master  # Monitor commits on the 'master' 

jobs:
  publish:
    runs-on: ubuntu-latest # Ubuntu machine for CI (continuous inte)

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Dependencies (Mosquitto + jq + OpenSSL)
        run: |
          sudo apt-get update
          sudo apt-get install -y mosquitto-clients jq openssl

      - name: Extract Latest Firmware URL
        id: extract_url
        run: |
          URL=$(jq -r '.firmware_versions[0].url' versions.json)
          echo "URL=$URL" >> $GITHUB_ENV

      - name: Apply PKCS#7 Padding to URL
        id: apply_padding
        run: |
          URL_LENGTH=${#URL}
          BLOCK_SIZE=16
          PADDING=$((BLOCK_SIZE - (URL_LENGTH % BLOCK_SIZE)))
          PADDED_URL="$URL$(printf "%0.s$(printf '\x%02x' "$PADDING")" $(seq 1 $PADDING))"
          echo "PADDED_URL=$PADDED_URL" >> $GITHUB_ENV
          echo "PADDED_LENGTH=$((URL_LENGTH + PADDING))" >> $GITHUB_ENV
          echo "PADDING=$PADDING" >> $GITHUB_ENV
          
      - name: Publish Padded Length to MQTT Topic
        run: |
          mosquitto_pub -h test.mosquitto.org -t "esp32/pad" -m "$PADDED_LENGTH"

      - name: Publish IV to MQTT
        env:
          AES_IV: ${{ secrets.AES_IV }}   # Using AES IV from GitHub secrets
        run: |
          mosquitto_pub -h test.mosquitto.org -t "esp32/iv" -m "$AES_IV"

      - name: Publish Key to MQTT
        env:
          AES_KEY: ${{ secrets.AES_KEY }}  # Using AES Key from GitHub secrets
        run: |
          mosquitto_pub -h test.mosquitto.org -t "esp32/key" -m "$AES_KEY"

      - name: Encrypt the Padded URL using AES
        id: encrypt_padded_url
        env:
          AES_KEY: ${{ secrets.AES_KEY }}   # Using AES KEY from secrets
          AES_IV: ${{ secrets.AES_IV }}     # Using AES IV from secrets
          PADDED_URL: ${{ env.PADDED_URL }} # The padded URL
        run: |
          echo -n "$URL" | openssl enc -aes-128-cbc -K $(echo -n $AES_KEY | xxd -p) -iv $(echo -n $AES_IV | xxd -p) -out encrypted_url.bin
          ENCRYPTED_URL_HEX=$(xxd -p encrypted_url.bin | tr -d '\n')
          echo "ENCRYPTED_URL_HEX=$ENCRYPTED_URL_HEX" >> $GITHUB_ENV

      - name: Generate MAC using HMAC SHA256
        id: generate_mac
        env:
          AES_KEY: ${{ secrets.AES_KEY }}   # Using AES KEY from secrets
        run: |
          echo -n "$ENCRYPTED_URL_HEX" | openssl dgst -sha256 -mac HMAC -macopt "key:$AES_KEY" | sed 's/^.* //g' > mac.txt
          MAC=$(cat mac.txt)
          echo "MAC=$MAC" >> $GITHUB_ENV

      - name: Publish Encrypted URL and MAC to MQTT Topic
        run: |
          mosquitto_pub -h test.mosquitto.org -t "inTopic" -m "$ENCRYPTED_URL_HEX"
          mosquitto_pub -h test.mosquitto.org -t "esp32/mac" -m "$MAC"
